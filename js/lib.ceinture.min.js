import protos from"./mods/protos.js";import utils from"./mods/utils.min.js";import common from"./mods/common.min.js";import cart from"./mods/cart.min.js";import Figure from"./mods/figure.min.js";const MM={},content=document.getElementById("creator-content"),parameters={};let separationFiches=!1,printMode="normal";function changeHeight(nb){let elts=document.querySelectorAll(".ans");for(let i=0;i<elts.length;i++)elts[i].style.height=nb+"pt"}function lightOrDark(color){let r,g,b,hsp;return color.match(/^rgb/)?(r=(color=color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/))[1],g=color[2],b=color[3]):(r=(color=+("0x"+color.slice(1).replace(color.length<5&&/./g,"$&$&")))>>16,g=color>>8&255,b=255&color),hsp=Math.sqrt(r*r*.299+g*g*.587+b*b*.114),hsp>127.5?"light":"dark"}function changeFontSize(dest,value){let elts=document.querySelectorAll(".question"+dest);for(let i=0;i<elts.length;i++)elts[i].style.fontSize=value+"pt"}function changeAllFontSize(value){let elts=document.querySelectorAll(".quest");for(let i=0;i<elts.length;i++)elts[i].style.fontSize=value+"pt";document.querySelectorAll("#textSizes input").forEach(el=>{el.value=value})}function setDispositionReponse(dest,how){let elts=document.querySelectorAll(".col"+dest);"row"===how?(elts.forEach(el=>{el.classList.remove("column")}),changeAnswerWidth(dest,document.getElementById("ansWidth"+dest).value)):(elts.forEach(el=>{el.classList.add("column")}),changeAnswerWidth(dest,100))}function setDispositionReponseAll(how){let elts=document.querySelectorAll(".ceinture .grid .flex"),selindex=1;"row"===how?(elts.forEach(el=>{el.classList.remove("column")}),selindex=0,document.querySelectorAll(".answidth").forEach(el=>{changeAnswerWidth(el.id.substring(8),el.value)})):(elts.forEach(el=>{el.classList.add("column")}),changeAnswerWidth("s","100",!1));let inputs=document.querySelectorAll(".selectpos");for(let i=0;i<inputs.length;i++)inputs[i].selectedIndex=selindex}function changeWidth(dest,nb){let elts=document.querySelectorAll(".ceinture-content");if(elts[0].style["grid-template-columns"].indexOf("auto")>-1)for(let i=0;i<elts.length;i++){let stylecols=elts[i].style["grid-template-columns"].split(" "),style=Array(stylecols.length).fill("1fr").join(" ");elts[i].style["grid-template-columns"]=style}for(let i=0;i<elts.length;i++){let style=elts[i].style["grid-template-columns"],stylecols=style.split(" ");stylecols[dest-1]=nb+"fr",style=stylecols.join(" "),elts[i].style["grid-template-columns"]=style}}function changeAnswerWidth(dest,width,changevalues=!0){"s"===dest?(document.querySelectorAll(".ceinture .flex:not(.column) .ans").forEach(el=>{el.style.width=width+"%"}),document.querySelectorAll(".ceinture .flex.column .ans").forEach(el=>{el.style.width=""}),changevalues&&document.querySelectorAll(".answidth").forEach(el=>{el.value=width})):(document.querySelectorAll(".ceinture .col"+dest+".flex:not(.column) div.ans").forEach(el=>{el.style.width=width+"%"}),document.querySelectorAll(".ceinture .col"+dest+".flex:not(.column) span.ans").forEach(el=>{el.style.width=width+"pt"}),document.querySelectorAll(".ceinture .col"+dest+".flex.column .ans").forEach(el=>{el.style.width=""}))}function changeColor(hexa,what,reset=!1){let styleAttr="background-color",styleVal=hexa;if("bgt"!==what){let elts=document.querySelectorAll(".ans");"bd"===what?(parameters.colorbd=hexa,styleAttr="border",styleVal="none"===hexa?"none":"1pt solid "+hexa):"bg"===what&&(parameters.colorbg=hexa);for(let i=0;i<elts.length;i++)elts[i].style[styleAttr]=styleVal}else if("bgt"===what){parameters.colorbgt=reset?"":hexa;let lumen=lightOrDark(parameters.colorbgt);document.querySelectorAll(".ceinture-titre").forEach(el=>{el.style[styleAttr]=parameters.colorbgt,el.style.color="dark"===lumen?"white":""})}}function changeBorder(bool){changeColor(bool?document.getElementById("colorpicker2").value:"none","bd")}function changeOrder(colId){let tableaux=document.querySelectorAll(".ceinture-content");for(let i=0;i<tableaux.length;i++){let cels=tableaux[i].querySelectorAll(".col"+colId),cles,start=0;cels[0].classList.contains("ceinture-titre-colonne")?(cels[0].style["grid-row"]=1,start=1,cles=[...Array(cels.length-1)].map((a,b)=>b+2)):cles=[...Array(cels.length)].map((a,b)=>b+1),cles.sort(()=>Math.random()-.5);for(let j=start;j<cels.length;j++)cels[j].style["grid-row"]=cles[j-start]}}function displayFigures(idcol){let btn,elts;"all"===idcol?(btn=document.getElementById("btndisplayfig"),elts=document.querySelectorAll("div.flex"),idcol="Toutes"):(btn=document.getElementById("btndisplayfig"+idcol),elts=document.querySelectorAll(".col"+idcol)),btn.innerHTML===idcol+" on"?(elts.forEach(el=>{el.classList.add("nofig")}),btn.innerHTML=idcol+" off"):(elts.forEach(el=>{el.classList.remove("nofig")}),btn.innerHTML=idcol+" on")}function displayEval(){let btn=document.getElementById("btndisplayeval"),headers=document.querySelectorAll(".ceinture-header");"Évaluation"===btn.innerHTML?(btn.innerHTML="sans Éval",headers.forEach(el=>{el.classList.add("evaluation")})):(btn.innerHTML="Évaluation",headers.forEach(el=>{el.classList.remove("evaluation")}))}function togglePrintMode(mode){document.querySelectorAll("div.ceinture:not(.original)").forEach(el=>{el.parentNode.removeChild(el)});let nb=document.getElementById("copiesByPage").value||3;printMode="multi"===mode?"multi":"normal"===printMode?"multi":"normal","multi"===printMode&&document.querySelectorAll("div.ceinture.original").forEach(el=>{for(let i=0;i<nb;i++){let copyEl=el.cloneNode(!0);copyEl.classList.remove("original"),document.getElementById("creator-content").insertBefore(copyEl,el.nextSibling)}})}function makePage(){let correction;content.innerHTML="",MM.memory={},parameters.alea&&common.setSeed(parameters.alea),"fin"===parameters.posCorrection&&(correction=utils.create("div",{id:"correction",className:"pagebreak"}),correction.appendChild(utils.create("div",{innerHTML:"Correction"})));let par4=!1;document.getElementById("par4").checked&&(par4=!0);let divsPar4=[],textSizes=document.getElementById("textSizes"),colSizes=document.getElementById("columnsWidth"),shuffleOrders=document.getElementById("columnsShuffles"),figuresDisp=document.getElementById("figuresDisplay"),dispositionsAns=document.getElementById("answersPositions"),answersSizes=document.getElementById("answersSizes");textSizes.innerHTML="",colSizes.innerHTML="",shuffleOrders.innerHTML="",figuresDisp.innerHTML="",dispositionsAns.innerHTML="",answersSizes.innerHTML="";for(let i=0;i<parameters.nbcols;i++)textSizes.innerHTML+=`<input id="fsize${i+1}" value="10" title="Taille énoncé colonne ${i+1}" type="number" size="3" min="8" max="16" step="0.5"></input>`,colSizes.innerHTML+=`<input id="asize${i+1}" value="1" title="Taille colonne ${i+1}" type="number" size="3" min="0.5" max="4" step="0.1">`,shuffleOrders.innerHTML+=`<button id="btnorder${i+1}">${i+1}</button>`,figuresDisp.innerHTML+=`<button id="btndisplayfig${i+1}">${i+1} on</button>`,dispositionsAns.innerHTML+=`<select id="selpos${i+1}" class="selectpos">\n        <option value="row">à côté</option>\n        <option value="column">dessous</option>\n        </select>`,answersSizes.innerHTML+=`<input type="number" class="answidth" id="ansWidth${i+1}" value="20" min="0" max="100" size="3" step="5">`;for(let qty=0;qty<parameters.nb;qty++){let ceinture=utils.create("div",{className:"ceinture original"}),corrige=utils.create("div",{className:"ceintCorrige corrige"});qty%4==0&&par4&&divsPar4.push(utils.create("div",{className:"parquatre"})),common.generateQuestions(parameters);let header=utils.create("div",{className:"ceinture-header evaluation"}),bloc1=utils.create("div",{className:"border-black ceinture-titre",innerHTML:parameters.titreCeinture}),bloc2=utils.create("div",{className:"border-black",innerHTML:"NOM :<br>Classe :"}),cleseed="";parameters.ceintprintToEnonce&&(cleseed="Clé : "+MM.seed+"<br> ");let bloc3=utils.create("div",{className:"border-black",innerHTML:cleseed+"grille "+(qty+1)}),blocevaluation=utils.create("div",{className:"border-black evaluation",innerHTML:"□ Validée<br>□ non Validée"});header.appendChild(bloc1),header.appendChild(bloc2),header.appendChild(blocevaluation),header.appendChild(bloc3),ceinture.appendChild(header),cleseed=parameters.ceintprintToCorrige?"Clé : "+MM.seed+" / ":"",corrige.appendChild(utils.create("div",{innerHTML:parameters.titreCeinture+"<br>"+cleseed+"grille : "+(qty+1),className:"border-black"}));let colsid=0,stylecols=Array(parameters.nbcols).fill("1fr").join(" "),stylecolscorrection=Array(parameters.nbcols).fill("auto").join(" "),stylerows=Array(parameters.nbrows).fill("auto").join(" ");const divColonnes=utils.create("div",{className:"ceinture-content grid",style:"grid-template-columns:"+stylecols+";grid-template-rows:"+(stylerows+1)});let divColsCorrige=utils.create("div",{className:"ceinture-corrige grid",style:"grid-template-columns:"+stylecolscorrection+";grid-template-rows:"+stylerows}),divCorr={},cols={},nbq=0;for(let i=0;i<parameters.cart.activities.length;i++){const activity=parameters.cart.activities[i];for(let j=0;j<activity.questions.length;j++){if(nbq%parameters.nbrows==0&&(colsid++,cols[colsid]=[],divCorr[colsid]=[],!_.isEmpty(parameters.titres))){let titre=parameters.titres[colsid-1]?parameters.titres[colsid-1]:"";cols[colsid].push(utils.create("div",{innerHTML:titre,className:"ceinture-titre-colonne border-black col"+colsid,style:"grid-column:"+colsid}))}nbq++;let ligne=utils.create("div",{className:"flex border-black col"+colsid,style:"grid-column:"+colsid}),divQuestion=utils.create("div",{className:"valign"}),ligneCorr=utils.create("div",{className:"grid border-black"}),divans=`<div class="bg-grey ans answer ${colsid}" style="height:20pt;"></div>`,content=activity.shortQuestions[j]||activity.questions[j],ansInside=!1;if(content.indexOf("_")>-1&&(ansInside=!0,divans=`<span class="bg-grey ans answer ${colsid}" style="height:20pt;"></span>`),"latex"===activity.type||""===activity.type||void 0===activity.type){let divq=utils.create("div",{className:"question"+colsid+" quest"}),span=utils.create("span",{className:"math",innerHTML:content});divq.appendChild(span),divQuestion.appendChild(divq)}else divQuestion.appendChild(utils.create("div",{innerHTML:content,className:"question"+colsid+" quest"}));if(void 0!==activity.figures[j]){let divfig=utils.create("div",{className:"fig"});divQuestion.appendChild(divfig),MM.memory[qty+"-f"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),qty+"-f"+i+"-"+j,divfig)}ligne.appendChild(divQuestion);let value=activity.values[j];Array.isArray(value)&&(value=value[0]);let spanc=utils.create("span",{innerHTML:value});void 0!==activity.type&&"latex"!==activity.type||spanc.classList.add("math"),ligneCorr.appendChild(spanc),divCorr[colsid].push(ligneCorr),ansInside?ligne.innerHTML=ligne.innerHTML.replaceAll("_",divans):ligne.innerHTML+=divans,cols[colsid].push(ligne),nbq%parameters.nbrows==0&&parameters.nbrows>0&&""!==parameters.pied&&cols[colsid].push(utils.create("div",{innerHTML:parameters.pied,className:"ceinture-pied-colonne border-black"}))}}for(let i=0;i<cols[1].length;i++)for(let j=1;j<=parameters.nbcols;j++)divColonnes.appendChild(cols[j][i]);ceinture.appendChild(divColonnes),content.appendChild(ceinture);for(let i=0;i<divCorr[1].length;i++)for(let j=1;j<=parameters.nbcols;j++)divColsCorrige.appendChild(divCorr[j][i]);corrige.appendChild(divColsCorrige),par4?(divsPar4[divsPar4.length-1].appendChild(corrige),qty%4==3&&content.appendChild(divsPar4[divsPar4.length-1])):"fin"===parameters.posCorrection?correction.appendChild(corrige):content.appendChild(corrige)}"fin"!==parameters.posCorrection||par4||content.appendChild(correction),void 0!==parameters.colorbd&&changeColor(parameters.colorbd,"bd"),void 0!==parameters.colorbg&&changeColor(parameters.colorbg,"bg"),utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display()}),300)}function refresh(){makePage(),common.mathRender(),content.oninput=evt=>{"input"===evt.target.nodeName.toLowerCase()&&changecols(evt.target.dataset.dest,evt.target.value)}}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression=/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi,regex=new RegExp(expression);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){vars.a?parameters.alea=vars.a:parameters.alea=common.setSeed();let json=vars.c;parameters.nb=Number(vars.n),parameters.posCorrection=vars.cor,parameters.titreCeinture=vars.t?decodeURI(vars.t):"Ceinture",parameters.nbcols=Number(vars.nc),parameters.nbrows=Number(vars.nr),parameters.ceintprintToEnonce=eval(vars.ke),parameters.ceintprintToCorrige=eval(vars.kc),parameters.titres=[],parameters.pied=decodeURI(vars.pie)||"",parameters.orientation=vars.or;for(let i=0;i<5;i++)void 0!==vars["t"+i]&&!1!==vars["t"+i]&&(parameters.titres[i]=decodeURIComponent(vars["t"+i]));document.getElementById("nbFiches").value=parameters.nb,parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{refresh()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert)})}}document.getElementById("creator-menu").onclick=evt=>{"toggleCorriges"===evt.target.id?("fin"===parameters.posCorrection?(parameters.posCorrection="apres",evt.target.innerHTML="séparé"):(parameters.posCorrection="fin",evt.target.innerHTML="suivant"),refresh()):"btnChangeBorder"===evt.target.id?changeBorder(evt.target.checked):"btndisplayfig"===evt.target.id?displayFigures("all"):"btndisplayeval"===evt.target.id?displayEval():0===evt.target.id.indexOf("btnorder")?changeOrder(evt.target.id.substr(8)):0===evt.target.id.indexOf("btndisplayfig")&&displayFigures(Number(evt.target.id.substr(13)))},document.getElementById("creator-menu").oninput=evt=>{0===evt.target.id.indexOf("fsize")?changeFontSize(Number(evt.target.id.substr(5)),evt.target.value):0===evt.target.id.indexOf("asize")?changeWidth(Number(evt.target.id.substr(5)),evt.target.value):0===evt.target.id.indexOf("selpos")?setDispositionReponse(Number(evt.target.id.substr(6)),evt.target.value):evt.target.id.indexOf(!1)&&changeAnswerWidth(evt.target.id.substr(8),evt.target.value)},document.getElementById("nbFiches").oninput=evt=>{"nbFiches"===evt.target.id&&(parameters.nb=evt.target.value),refresh()},document.getElementById("inputheight").oninput=evt=>{changeHeight(evt.target.value)},document.getElementById("fsize").oninput=evt=>{changeAllFontSize(evt.target.value)},document.getElementById("setAnswerAllPos").oninput=evt=>{setDispositionReponseAll(evt.target.value)},document.getElementById("colorpicker").oninput=evt=>{changeColor(evt.target.value,"bg")},document.getElementById("colorpicker2").oninput=evt=>{changeColor(evt.target.value,"bd"),document.getElementById("btnChangeBorder").checked=!0},document.getElementById("colorpickertitle").oninput=evt=>{changeColor(evt.target.value,"bgt")},document.getElementById("colorpickertitle").oncontextmenu=evt=>{changeColor("","bgt",!0),evt.target.value="#CCCCCC"},document.getElementById("btnPrintMode").onclick=evt=>{"Répéter chaque version"===evt.target.innerHTML?evt.target.innerHTML="Supprimer les copies":evt.target.innerHTML="Répéter chaque version",togglePrintMode()},document.getElementById("copiesByPage").oninput=evt=>{let btn=document.getElementById("btnPrintMode");0===evt.target.value?btn.innerHTML="Répéter chaque version":btn.innerHTML="Supprimer les copies",togglePrintMode("multi")},document.getElementById("par4").onclick=()=>{refresh()},checkURL();