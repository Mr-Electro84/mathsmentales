import protos from"./mods/protos.min.js";import utils from"./mods/utils.min.js";import common from"./mods/common.min.js";import cart from"./mods/cart.min.js";import Zoom from"./mods/zoom.min.js";import Figure from"./mods/figure.min.js";const MM={},content=document.getElementById("creator-content"),parameters={};let separationFiches=!1,zoom;function changecols(dest,nb){const elem=document.getElementById(dest);null!==elem&&(elem.className="grid g"+nb)}function cacheEspaceReponse(){document.querySelectorAll(".interro article").forEach(el=>{el.classList.toggle("invisible")})}function changeheight(dest,nb){let elts=document.querySelectorAll("#"+dest+" .interro article");for(let i=0;i<elts.length;i++)elts[i].style.height=nb+"pt"}function setNumberFiches(nb){parameters.nb=Number(nb),refresh()}function pagebreak(){let cor=document.querySelectorAll(".correction"),btn=document.getElementById("btn-break");if(cor[0].classList.contains("pagebreak")){for(let i=0;i<cor.length;i++)cor[i].classList.remove("pagebreak");btn.innerText="√† part"}else{for(let i=0;i<cor.length;i++)cor[i].classList.add("pagebreak");btn.innerText="m√™me feuille"}}function makePage(){parameters.alea&&common.setSeed(parameters.alea),content.innerHTML="","end"!==parameters.positionCorrection||document.getElementById("btn-break")||document.getElementById("btpCorrigePlace").appendChild(utils.create("button",{id:"btn-break",innerText:"√† part",title:"Ne pas mettre sur la m√™me feuille que le sujet"})),MM.memory={};for(let qty=0;qty<parameters.nb;qty++){common.generateQuestions(parameters),qty>0&&content.appendChild(utils.create("footer"));const aleaCode=utils.create("div",{className:"floatright",innerHTML:"p."+(qty+1)});content.appendChild(aleaCode);const sheetTitle=parameters.titreFiche,header=utils.create("header",{innerHTML:sheetTitle});content.appendChild(header);const div1=utils.create("div",{className:"studenName",innerHTML:"Nom, pr√©nom, classe :"});content.appendChild(div1);const div2=utils.create("div",{className:"remarques",innerHTML:"Remarques :"});content.appendChild(div2);let exTitle=parameters.titreExercices;const correctionContent=utils.create("div",{className:"correction"}),titleCorrection=utils.create("header",{className:"clearfix",innerHTML:"Correction"});correctionContent.appendChild(titleCorrection);const divclear=utils.create("div",{className:"clearfix"});let activitiesArray=[];for(let i=0;i<parameters.cart.activities.length;i++)for(let j=0;j<parameters.cart.activities[i].questions.length;j++)activitiesArray.push([i,j]);parameters.cart.ordered||(activitiesArray=utils.shuffle(activitiesArray));let lastActivityIndex=0,ol,olCorrection,h3,input,activityTitle;for(let i=0;i<activitiesArray.length;i++){const actIndex=activitiesArray[i][0],activity=parameters.cart.activities[actIndex],j=activitiesArray[i][1],sectionEnonce=utils.create("section",{id:"section"+qty+"-"+i}),sectionCorrection=utils.create("section");(lastActivityIndex!==actIndex&&parameters.cart.ordered||0===i)&&(input=`<input id="inputheight${qty}-${i}" class="noprint fright" value="30" title="Taille r√©ponse" type="number" size="3" min="10" max="200" data-target="${qty}-${i}">`,sectionEnonce.innerHTML+=input,input=`<input id="nbcols${qty}-${i}" class="noprint fright" value="2" title="Nb de colonnes" type="number" size="2" min="1" max="6" data-target="${qty}-${i}">`,sectionEnonce.innerHTML+=input,activityTitle=parameters.cart.ordered?exTitle+(actIndex+1)+" : "+activity.title:exTitle,h3=utils.create("h3",{className:"exercice-title",innerHTML:activityTitle}),sectionEnonce.appendChild(h3),activity.consigne&&sectionEnonce.appendChild(utils.create("div",{className:"consigne",innerHTML:activity.consigne})),ol=utils.create("ol",{id:"ol"+qty+"-"+i,className:"grid g2"}),olCorrection=utils.create("ol",{className:"corrige"}));const li=utils.create("li",{className:"interro"}),liCorrection=utils.create("li");if("latex"===activity.type||""===activity.type||void 0===activity.type){const span=utils.create("span",{className:"math",innerHTML:activity.questions[j]}),spanCorrection=utils.create("span",{className:"math",innerHTML:activity.answers[j]});li.appendChild(span),liCorrection.appendChild(spanCorrection)}else li.innerHTML=activity.questions[j],liCorrection.innerHTML=activity.answers[j];ol.appendChild(li),void 0!==activity.figures[j]&&(MM.memory["f"+qty+"-"+i+"-"+j]=new Figure(utils.clone(activity.figures[j]),"f"+qty+"-"+i+"-"+j,li));const article=utils.create("article");li.appendChild(article),olCorrection.appendChild(liCorrection),sectionEnonce.appendChild(ol);const ds=divclear.cloneNode(!0);if(sectionEnonce.appendChild(ds),lastActivityIndex!==actIndex&&parameters.cart.ordered||0===i){const h3correction=h3.cloneNode(!0);sectionCorrection.appendChild(h3correction),lastActivityIndex=actIndex}sectionCorrection.appendChild(olCorrection),correctionContent.appendChild(sectionCorrection),content.appendChild(sectionEnonce)}content.appendChild(utils.create("footer")),content.appendChild(correctionContent);const ds=divclear.cloneNode(!0);content.appendChild(ds)}utils.isEmpty(MM.memory)||setTimeout((function(){for(const k in MM.memory)"dest"!==k&&MM.memory[k].display()}),300)}function refresh(){makePage(),common.mathRender(),content.oninput=evt=>{"input"===evt.target.nodeName.toLowerCase()&&changecols(evt.target.dataset.dest,evt.target.value)}}function checkURL(urlString){const vars=utils.getUrlVars(urlString);if(void 0!==vars.embed){let expression,regex=new RegExp(/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}|www\.[a-zA-Z0-9]+\.[^\s]{2,})/gi);vars.embed.match(regex)&&(MM.embededIn=vars.embed)}if(void 0!==vars.c){vars.a?parameters.alea=vars.a:parameters.alea=common.setSeed();let json=vars.c;parameters.tailleTexte=Number(vars.s),parameters.nb=Number(vars.n),parameters.positionCorrection=vars.cor||"end",parameters.titreFiche=decodeURI(vars.t),parameters.titreExercices=decodeURI(vars.ex).trim()+" ".replace("üì£",""),parameters.enoncesSepares=vars.es||0,parameters.corrigeSepare=vars.cs||0,parameters.activitesColonnes=vars.cols||[],parameters.doublons=!0,Array.isArray(parameters.activitesColonnes)||parameters.activitesColonnes.split("~"),parameters.corrigesVisibles=vars.cv||[],Array.isArray(parameters.corrigesVisibles)||parameters.corrigesVisibles.split("~"),document.getElementById("nbFiches").value=parameters.nb,zoom=new Zoom("changeFontSize","#thehtml",!0,"pt",parameters.tailleTexte),document.getElementById("creator-menu").appendChild(zoom.createCursor()),document.querySelector("html").style.fontSize=parameters.tailleTexte+"pt",parameters.cart=new cart(0),parameters.cart.import(json[0],!1).then(()=>{refresh()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger le panier :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert)})}}document.getElementById("creator-menu").onclick=evt=>{if("in"===evt.target.dataset.what)zoom.plus();else if("out"===evt.target.dataset.what)zoom.minus();else if("btn-break"===evt.target.id)pagebreak();else if("fichesSeparation"===evt.target.id)separationFiches?(separationFiches=!1,document.getElementById(evt.target.id).innerText="S√©parer",document.querySelectorAll("footer").forEach(elt=>{elt.className=""})):(separationFiches=!0,document.getElementById(evt.target.id).innerText="Regrouper",document.querySelectorAll("footer").forEach(elt=>{elt.className="break"}));else if("toggleCorriges"===evt.target.id){let lesCorriges=document.querySelectorAll("ol.corrige");" ‚ñº "===evt.target.innerHTML?(evt.target.innerHTML=" ‚ñ≤ ",lesCorriges.forEach(el=>{el.classList.remove("hidden")}),document.querySelectorAll(".correction").forEach(el=>{el.classList.remove("noprint")}),document.querySelectorAll(".correction .titreCorrection").forEach(el=>{el.classList.remove("noprint")})):(evt.target.innerHTML=" ‚ñº ",document.querySelectorAll(".correction").forEach(el=>{el.classList.add("noprint")}),document.querySelectorAll(".correction .titreCorrection").forEach(el=>{el.classList.add("noprint")}),lesCorriges.forEach(el=>{el.classList.add("hidden")}))}else"btn-hide-inputanswer"===evt.target.id?cacheEspaceReponse():"fusionEnonces"===evt.target.id&&(parameters.cart.ordered=!parameters.cart.ordered,refresh())},document.getElementById("creator-menu").oninput=evt=>{"nbFiches"===evt.target.id&&setNumberFiches(evt.target.value)},document.getElementById("creator-content").onclick=evt=>{if(0===evt.target.id.indexOf("idCorrige")){let target;document.getElementById(evt.target.id.replace("idCorrige","corrige")).classList.toggle("hidden")?document.getElementById(evt.target.id).classList.add("noprint"):document.getElementById(evt.target.id).classList.remove("noprint")}else if(0===evt.target.id.indexOf("titreExo")){let target;if(document.getElementById(evt.target.id.replace("titreExo","corrige")).classList.toggle("hidden")){document.querySelector(".correction #"+evt.target.id).classList.add("noprint");let invisible=!0;document.querySelectorAll(".correction .titreCorrection").forEach(el=>{el.classList.contains("noprint")||(invisible=!1)}),invisible&&document.querySelectorAll(".correction").forEach(el=>{el.classList.add("noprint")})}else document.querySelector(".correction #"+evt.target.id).classList.remove("noprint"),document.querySelectorAll(".correction").forEach(el=>{el.classList.remove("noprint")})}else 0===evt.target.id.indexOf("inputheight")?changeheight("ol"+evt.target.dataset.target,evt.target.value):0===evt.target.id.indexOf("nbcols")&&changecols("ol"+evt.target.dataset.target,evt.target.value)},checkURL();