import math from"./math.min.js";import activity from"./activity.min.js";import MM from"./MM.min.js";import utils from"./utils.min.js";export default class cart{constructor(id){this.id=id,this.activities=[],this.ordered=!0,this.sortable=void 0,this.editedActivityId=-1,this.target=[id],this.nbq=0,this.time=0,this.title="Diapo "+(id+1),this.loaded=!1}export(){let urlString="&p="+this.id+"~t="+encodeURI(this.title)+"~c="+this.target+"~o="+this.ordered;for(let i=0,l=this.activities.length;i<l;i++)urlString+="_"+this.activities[i].export();return urlString}import(obj,start=!1){this.title=obj.t,this.target=obj.c,"false"!==obj.o&&obj.o?this.ordered=!0:this.ordered=!1;let activities=[];for(const i in obj.a)activities.push(activity.import(obj.a[i],i));return Promise.all(activities).then(data=>{data.forEach(table=>{this.activities[table[0]]=table[1]}),this.loaded=!0,null!==document.querySelector("#tab-parameters")&&this.display(),start&&MM.checkLoadedCarts()}).catch(err=>{let alert=utils.create("div",{id:"messageerreur",className:"message",innerHTML:"Impossible de charger tous les exercices :(<br>"+err});document.getElementById("tab-accueil").appendChild(alert),setTimeout(()=>{let div=document.getElementById("messageerreur");div.parentNode.removeChild(div)},3e3)})}duplicate(){if(MM.carts.length<4){MM.addCart();let cart=MM.carts[MM.carts.length-1];for(let i=0;i<this.activities.length;i++)cart.addActivity(this.activities[i]);cart.display()}}addActivity(obj,nbQuestions=!1){this.editedActivityId=-1;let temp=new activity(obj);nbQuestions&&(temp.nbq=nbQuestions),this.activities.push(temp),this.display()}removeActivity(index){this.editedActivityId===index?this.editedActivityId=-1:this.editedActivityId>index&&this.editedActivityId--,this.activities.splice(index,1),this.display()}exchange(oldIndex,newIndex){let indexes=this.activities.getKeys(),tempindexes=indexes[oldIndex],temp=this.activities[oldIndex];this.activities.splice(oldIndex,1),indexes.splice(oldIndex,1),this.activities.splice(newIndex,0,temp),indexes.splice(newIndex,0,tempindexes),this.editedActivityId=Number(indexes.indexOf(this.editedActivityId)),this.display()}display(){document.querySelector("#cart"+this.id+" h3").innerText=this.title;let dom=document.getElementById("cart"+this.id+"-list");dom.innerHTML="",this.time=0,this.nbq=0;let spanOrder=document.querySelector("#cart"+this.id+" span[data-ordered]");this.ordered?(spanOrder.innerHTML="ordonné",spanOrder.dataset.ordered="true"):(spanOrder.innerHTML="mélangé",spanOrder.dataset.ordered="false");for(let i=0,l=this.activities.length;i<l;i++){let li=document.createElement("li"),activity=this.activities[i];this.time+=Number(activity.tempo)*Number(activity.nbq),this.nbq+=Number(activity.nbq),li.innerHTML="<img src='img/editcart.png' align='left' data-actid='"+i+"' title=\"Editer l'activité\"><img src='img/removefromcart.png' data-actidtoremove='"+i+"' title='Enlever du panier' class='removefromcartbutton'>"+activity.title+" (<span>"+activity.tempo+"</span> s. / <span>"+activity.nbq+"</span> quest.)",MM.carts[this.id].editedActivityId===i&&(li.className="active"),dom.appendChild(li)}let spans=document.querySelectorAll("#cart"+this.id+" div.totaux span");spans[0].innerHTML=math.sToMin(this.time),spans[1].innerHTML=this.nbq,spans[2].innerHTML=this.target,this.sortable&&this.sortable.destroy(),this.sortable=new Sortable(dom,{animation:150,ghostClass:"ghost-movement",onEnd:evt=>MM.carts[this.id].exchange(evt.oldIndex,evt.newIndex)})}changeOrder(objImage){"true"===objImage.dataset.ordered?(objImage.innerHTML="mélangé",objImage.title="Affichage mélangé des questions",objImage.dataset.ordered="false",this.ordered=!1):(objImage.innerHTML="ordonné",objImage.title="Affichage dans l'ordre des activités",objImage.dataset.ordered="true",this.ordered=!0)}}